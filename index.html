<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Lite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        discord: {
                            blurple: '#5865F2',
                            green: '#23a559',
                            yellow: '#fee75c',
                            fuchsia: '#eb459e',
                            red: '#ed4245',
                        }
                    }
                }
            }
        }
    </script>
    <style>
:root {
    --bg-primary: #ffffff;
    --bg-secondary: #f2f3f5;
    --bg-tertiary: #ebedef;
    --bg-floating: #ffffff;
    --text-normal: #060607;
    --text-muted: #5e6772;
    --text-link: #00b0f4;
    --header-primary: #060607;
    --header-secondary: #4f5660;
    --scrollbar-track: #2b2d31;
    --scrollbar-thumb: #1a1b1e;
    --channel-selected: #e0e1e5;
    --channel-hover: #eaebed;
    --message-hover: #f8f9f9; 
    --divider: #e3e5e8;
    
    --mention-bg: rgba(88, 101, 242, 0.15);
    --mention-hover: rgba(88, 101, 242, 0.3);
    
    --bot-badge-bg: #5865F2;
    --folder-color: #5865F2;
}

html.dark {
    --bg-primary: #313338;
    --bg-secondary: #2b2d31;
    --bg-tertiary: #1e1f22;
    --bg-floating: #18191c; /* popups */
    --text-normal: #dbdee1;
    --text-muted: #949ba4;
    --text-link: #00b0f4;
    --header-primary: #f2f3f5;
    --header-secondary: #b5bac1;
    --scrollbar-track: #2b2d31;
    --scrollbar-thumb: #1a1b1e;
    --channel-selected: #3f4147;
    --channel-hover: #35373c;
    --message-hover: rgba(2, 2, 2, 0.06); 
    --divider: #3e4147;

    --mention-bg: rgba(250, 166, 26, 0.1); 
    --bot-badge-bg: #5865F2;
}

/* Base resets */
body { background-color: var(--bg-primary); color: var(--text-normal); }
.no-scrollbar::-webkit-scrollbar { display: none; }
::-webkit-scrollbar { width: 8px; height: 8px; background-color: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 4px; }
.input-reset { background: transparent; border: none; outline: none; }

/* Message Container Layout */
#message-container { overflow-anchor: none; }

/* Servers */
.server-icon {
    width: 48px; height: 48px; min-height: 48px;
    border-radius: 50%;
    cursor: pointer; transition: all 0.2s ease-out;
    background-color: var(--bg-primary);
    display: flex; align-items: center; justify-content: center;
    position: relative; z-index: 10;
}
.server-icon img { border-radius: 50%; transition: border-radius 0.2s; }
.server-icon:hover, .server-icon.active { border-radius: 16px; background-color: var(--discord-blurple); }
.server-icon:hover img, .server-icon.active img { border-radius: 16px; }
.server-icon.active::before {
    content: ''; position: absolute; left: -14px; top: 12px; height: 24px; width: 8px;
    background-color: var(--header-primary); border-radius: 0 4px 4px 0;
}

/* Channels */
.channel-item.active { background-color: var(--channel-selected); color: var(--text-normal); }
.channel-item:hover:not(.active) { background-color: var(--channel-hover); color: var(--text-normal); }
.category-collapsed .cat-arrow { transform: rotate(-90deg); }

/* Messages Structure - FIX for Spacing/Indent */
.message-wrapper {
    position: relative;
    padding-top: 0.125rem; 
    padding-bottom: 0.125rem;
    padding-left: 1rem; padding-right: 1rem; /* Standard margin */
    word-wrap: break-word;
    user-select: text;
    width: 100%;
    display: flex;
    flex-direction: column; /* Á∏¶‰∏¶„Å≥ÔºàReferenceÂØæÂøúÔºâ */
}

/* Extra Margin for distinct message groups (not grouped) */
.message-wrapper.mt-cozy { margin-top: 1.75rem !important; } 

.message-wrapper:hover { background-color: var(--message-hover); }

/* Content Row: Avatar(Left) + Main(Right) */
.msg-row {
    display: flex;
    flex-direction: row;
    width: 100%;
}

/* Left Column (Avatar/Gutter) - FIXED WIDTH */
.msg-left-col {
    width: 3rem; /* 48px (Avatar is 40px) */
    margin-right: 1rem;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    /* align-items: center; */ /* Remove center to handle marginTop manually */
}

/* Avatar Handling */
.avatar-container {
    width: 40px; height: 40px;
    position: relative; 
    cursor: pointer;
    margin-top: 2px;
}
.avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

/* Avatar Decoration - INCREASED SIZE */
.avatar-decoration {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 150%; height: 150%; /* Bigger */
    pointer-events: none; z-index: 10;
}

/* Right Column (Header + Body) */
.msg-right-col {
    flex: 1;
    min-width: 0;
}

.msg-header {
    display: flex; align-items: center; gap: 0.5rem;
    line-height: 1.375rem;
    margin-bottom: 0.1rem;
}
.msg-username { font-weight: 500; cursor: pointer; color: var(--text-normal); }
.msg-username:hover { text-decoration: underline; }
.msg-timestamp { font-size: 0.75rem; color: var(--text-muted); cursor: default; margin-left: 0.25rem; }

.msg-content {
    font-size: 1rem;
    line-height: 1.375rem;
    color: var(--text-normal);
    white-space: pre-wrap;
    overflow-wrap: break-word;
}

/* Grouped Message Indent - matches left column */
/* Since we use flex row, if avatar is empty, msg-right-col still renders correct pos */
.grouped-gutter {
    width: 100%; height: 100%;
    /* Grouped hover timestamp here in future */
}

/* Reply/Reference Styling */
.reference-line {
    display: flex; align-items: center; gap: 0.5rem;
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-muted);
    opacity: 0.8;
    position: relative;
    margin-left: 1.2rem; /* Adjusted indent */
}
.reference-spine {
    position: absolute;
    top: 50%; left: -1.75rem; width: 34px; height: 12px;
    border-left: 2px solid var(--text-muted);
    border-top: 2px solid var(--text-muted);
    border-top-left-radius: 6px; pointer-events: none; opacity: 0.4;
    margin-top: 2px;
}

/* Bot Tag */
.bot-badge {
    background-color: var(--bot-badge-bg);
    color: white; font-size: 0.625rem;
    padding: 0 0.275rem; border-radius: 0.1875rem;
    font-weight: 500; text-transform: uppercase;
    line-height: 1.3; vertical-align: baseline;
    display: inline-flex; align-items: center; justify-content: center;
    margin-left: 0.25rem; height: 15px;
}
.bot-badge svg { margin-right: 2px; }

/* Mentions */
.mention { background-color: var(--mention-bg); color: var(--discord-blurple); padding: 0 2px; border-radius: 3px; font-weight: 500; cursor: pointer; }
.mention:hover { background-color: var(--bot-badge-bg); color: white; }

/* Ephemeral Message (Clyde/System) */
.ephemeral-message { border-left: 4px solid var(--discord-blurple); background-color: rgba(88,101,242, 0.05); }
.ephemeral-text { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

/* Toolbar */
.msg-toolbar {
    position: absolute; right: 1rem; top: -16px;
    background-color: var(--bg-primary); border: 1px solid var(--divider);
    border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: none; align-items: center; z-index: 50; padding: 2px;
}
.message-wrapper:hover .msg-toolbar { display: flex; }
.toolbar-btn {
    padding: 4px; cursor: pointer; color: var(--text-muted);
    border-radius: 4px; transition: color 0.1s;
}
.toolbar-btn:hover { background-color: var(--bg-tertiary); color: var(--text-normal); }

/* SVG Utilities */
.icon-svg { width: 1.25rem; height: 1.25rem; }
.icon-svg-sm { width: 1rem; height: 1rem; }

/* Settings Modal etc */
#drag-overlay {
    pointer-events: none; opacity: 0; transition: opacity 0.2s;
    background: rgba(88, 101, 242, 0.9);
}
.dragging #drag-overlay { opacity: 1; pointer-events: auto; }

.ctx-menu {
    position: fixed; z-index: 9999;
    background: var(--bg-floating); border-radius: 4px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.24); padding: 6px 0;
    min-width: 180px;
}
.ctx-item {
    padding: 6px 12px; cursor: pointer; color: var(--text-muted); font-size: 14px;
    display: flex; justify-content: space-between;
}
.ctx-item:hover { background-color: var(--discord-blurple); color: white; }

</style>
</head>
<body class="font-sans h-screen flex flex-col overflow-hidden bg-[var(--bg-tertiary)]">
    
    <!-- Drag Overlay -->
    <div id="drag-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center m-4 rounded-xl border-4 border-dashed border-white">
        <svg class="w-20 h-20 text-white animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
        <div class="text-white text-2xl font-bold mt-4">„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
    </div>

    <!-- Context Menu -->
    <div id="ctx-menu" class="hidden ctx-menu"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-[var(--bg-primary)] w-[800px] h-[600px] rounded flex overflow-hidden shadow-2xl scale-95 transition-transform duration-200" id="settings-inner">
            <div class="w-[220px] bg-[var(--bg-secondary)] p-2 pt-8 flex flex-col gap-1 overflow-y-auto">
                <div class="px-2 pb-2 text-xs font-bold text-[var(--text-muted)] uppercase">User Settings</div>
                <div id="tab-btn-plugins" class="px-2 py-1.5 rounded cursor-pointer text-[var(--text-muted)] hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-normal)] active bg-[var(--bg-tertiary)] text-[var(--text-normal)]" onclick="switchSettingsTab('plugins')">„Éó„É©„Ç∞„Ç§„É≥</div>
                <div id="tab-btn-general" class="px-2 py-1.5 rounded cursor-pointer text-[var(--text-muted)] hover:bg-[var(--bg-tertiary)] hover:text-[var(--text-normal)]" onclick="switchSettingsTab('general')">Â§ñË¶≥</div>
            </div>
            <div class="flex-1 p-10 bg-[var(--bg-primary)] relative overflow-y-auto">
                <div class="absolute top-4 right-4 text-[var(--text-muted)] hover:text-[var(--text-normal)] cursor-pointer" onclick="closeSettings()">
                    <div class="p-1 border-2 border-[var(--text-muted)] rounded-full flex flex-col items-center justify-center h-8 w-8 text-sm font-bold">ESC</div>
                </div>
                
                <div id="tab-content-plugins" class="block">
                    <h2 class="text-xl font-bold mb-6">„Éó„É©„Ç∞„Ç§„É≥Ë®≠ÂÆö</h2>
                    <div id="plugin-list" class="flex flex-col gap-4"></div>
                </div>
                
                <div id="tab-content-general" class="hidden">
                    <h2 class="text-xl font-bold mb-6">Â§ñË¶≥</h2>
                    <div class="mb-4">
                        <div class="text-sm font-bold text-[var(--text-muted)] mb-2 uppercase">„ÉÜ„Éº„Éû</div>
                        <div class="flex gap-4">
                            <div class="w-32 h-20 bg-[#313338] rounded-lg border-2 border-transparent cursor-pointer ring-offset-2 ring-[var(--discord-blurple)] relative flex items-center justify-center group" id="theme-card-dark" onclick="setTheme('dark')">
                                <span class="text-white font-bold">Dark</span>
                                <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-[var(--discord-blurple)] flex items-center justify-center text-white hidden checked-mark">‚úì</div>
                            </div>
                            <div class="w-32 h-20 bg-white rounded-lg border border-gray-300 cursor-pointer flex items-center justify-center relative group" id="theme-card-light" onclick="setTheme('light')">
                                <span class="text-black font-bold">Light</span>
                                <div class="absolute top-2 right-2 w-4 h-4 rounded-full bg-[var(--discord-blurple)] flex items-center justify-center text-white hidden checked-mark">‚úì</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login / Auth -->
    <div id="auth-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 hidden">
        <div class="bg-[var(--bg-primary)] p-8 rounded shadow-lg max-w-sm w-full">
            <h2 class="text-2xl font-bold text-center mb-6">Welcome Back</h2>
            <div id="auth-account-list" class="flex flex-col gap-2 max-h-60 overflow-y-auto mb-4"></div>
            
            <div id="auth-token-form" class="hidden">
                <label class="block text-xs font-bold text-[var(--text-muted)] uppercase mb-2">Token</label>
                <input type="password" id="input-token" class="w-full bg-[var(--bg-tertiary)] text-[var(--text-normal)] p-2 rounded outline-none border border-transparent focus:border-[var(--discord-blurple)]" placeholder="Token...">
                <div id="auth-error" class="text-[var(--discord-red)] text-xs mt-2 h-4"></div>
                <button id="btn-login" class="w-full bg-[var(--discord-blurple)] text-white font-medium p-2 rounded mt-4 hover:bg-opacity-90">„É≠„Ç∞„Ç§„É≥</button>
                <div class="text-xs text-[var(--text-link)] mt-2 cursor-pointer hover:underline text-center" onclick="showSavedAccounts()">‰øùÂ≠ò„Åï„Çå„Åü„Ç¢„Ç´„Ç¶„É≥„Éà„Å´Êàª„Çã</div>
            </div>

            <button id="btn-show-add" class="text-sm text-[var(--text-link)] block mx-auto hover:underline mt-2">Âà•„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíËøΩÂä†</button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-root" class="flex w-full h-full relative">
        <!-- Sidebar: Guilds -->
        <nav class="w-[72px] bg-[var(--bg-tertiary)] flex flex-col items-center py-3 overflow-y-auto no-scrollbar gap-2 shrink-0">
            <div id="btn-dm" class="server-icon bg-[#5865F2]" title="„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏" onclick="loadDMs()">
                <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" style="display:none"></path>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" style="display:none"></path>
                <!-- Official Discord Icon Lookalike -->
                <path d="M19.73 4.87a18.2 18.2 0 00-4.6-1.44c-.21.4-.4.8-.58 1.21-1.69-.25-3.4-.25-5.1 0-.18-.41-.37-.82-.59-1.2-1.6.27-3.14.75-4.6 1.43.3 2.37.59 13.8 9.9 14.8" fill="none"></path>
                <path d="M18.92 5.09C17.33 4.4 15.65 3.96 13.9 3.65c-.21.41-.41.83-.59 1.25-1.58-.23-3.18-.23-4.75 0-.19-.42-.39-.84-.6 1.25C6.31 4 4.63 4.44 3.06 5.09 1.94 11.23 3.32 17.15 7.15 20.84c1.86.84 3.77 1.34 5.37 1.48.24-.61.66-1.5 1.05-1.95-3.32-.47-5.07-2.3-5.07-2.3 2.76 1.35 5.75 1.57 7.74 1.35 0 0-1.72 1.83-5.03 2.3.38.45.8 1.35 1.05 1.95 1.59-.14 3.51-.64 5.37-1.48 3.51-3.6 5.06-9.13 4.14-15.35zM9.44 14.88c-1.13 0-2.07-1.03-2.07-2.28 0-1.26.91-2.28 2.07-2.28 1.17 0 2.1 1.02 2.1 2.28 0 1.25-.92 2.28-2.1 2.28zm5.11 0c-1.13 0-2.06-1.03-2.06-2.28 0-1.26.92-2.28 2.06-2.28 1.16 0 2.09 1.02 2.09 2.28 0 1.25-.92 2.28-2.09 2.28z"></path>
                </svg>
            </div>
            <div class="w-8 h-[2px] rounded-lg bg-[var(--bg-secondary)] shrink-0"></div>
            <div id="guild-list" class="flex flex-col items-center gap-2 w-full"></div>
        </nav>

        <!-- Sidebar: Channels -->
        <div class="w-60 bg-[var(--bg-secondary)] flex flex-col shrink-0">
            <div id="guild-header" class="h-12 border-b border-[var(--divider)] flex items-center px-4 font-bold shadow-sm hover:bg-[var(--channel-hover)] cursor-pointer truncate">
                Discord Lite
            </div>
            <div id="channel-list" class="flex-1 overflow-y-auto p-2 no-scrollbar"></div>
            
            <!-- User Control -->
            <div class="h-[52px] bg-[var(--bg-floating)] flex items-center px-2 gap-2 shrink-0">
                <div class="w-8 h-8 relative rounded-full overflow-hidden cursor-pointer hover:opacity-80 group">
                    <img id="current-user-avatar" src="" class="w-full h-full object-cover">
                </div>
                <div class="flex-1 overflow-hidden">
                    <div id="current-user-name" class="text-sm font-bold truncate text-[var(--text-normal)]"></div>
                    <div id="current-user-discriminator" class="text-xs text-[var(--text-muted)] truncate"></div>
                </div>
                <!-- User Setting Cog SVG (From User) -->
                <button class="p-1.5 rounded hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)] hover:text-[var(--text-normal)] cursor-pointer" onclick="openSettings()">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col min-w-0 bg-[var(--bg-primary)]">
            <div class="h-12 border-b border-[var(--divider)] flex items-center px-4 font-bold shadow-sm shrink-0 bg-[var(--bg-primary)] z-20">
                <span class="text-[var(--text-muted)] text-xl mr-2 font-thin" id="header-hash">#</span>
                <span id="header-channel-name" class="truncate">Select a channel</span>
            </div>
            
            <!-- Messages -->
            <div id="message-container" class="flex-1 overflow-y-scroll p-4 space-y-0 relative">
                <!-- Messages inserted here -->
                <div class="h-full w-full flex items-center justify-center text-[var(--text-muted)] select-none">
                    „ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-[var(--bg-primary)] shrink-0 z-30">
                <!-- Reply Bar -->
                <div id="reply-bar" class="bg-[var(--bg-tertiary)] px-4 py-2 text-xs text-[var(--text-muted)] flex justify-between items-center rounded-t-lg hidden border-b border-[var(--divider)]">
                    <span class="truncate">Replying to <b id="reply-user">User</b></span>
                    <button id="btn-cancel-reply" class="hover:text-[var(--text-normal)]">
                        <svg class="icon-svg-sm" viewBox="0 0 24 24" fill="currentColor"><path d="M18.3 5.71a.9959.9959 0 0 0-1.41 0L12 10.59 7.11 5.7a.9959.9959 0 0 0-1.41 0c-.38.39-.39 1.03 0 1.42l4.89 4.89-4.89 4.89a.9959.9959 0 0 0 0 1.41c.39.38 1.03.39 1.42 0L12 13.41l4.89 4.89c.38.38 1.02.39 1.41 0 .39-.38.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/></svg>
                    </button>
                </div>
                <!-- File Preview -->
                <div id="file-preview-list" class="bg-[var(--bg-tertiary)] px-4 py-2 border-b border-[var(--divider)] flex gap-2 flex-wrap hidden rounded-t-lg"></div>

                <!-- Main Input -->
                <div id="input-wrapper" class="bg-[var(--bg-tertiary)] p-3 rounded-lg flex items-start gap-2 border border-transparent focus-within:border-none relative shadow-inner">
                    <button class="text-[var(--text-muted)] hover:text-[var(--text-normal)] p-1 rounded-full shrink-0" onclick="document.getElementById('file-input').click()">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                    </button>
                    <input type="file" id="file-input" class="hidden" multiple>
                    
                    <textarea id="message-input" rows="1" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°" class="flex-1 bg-transparent text-[var(--text-normal)] resize-none py-1 px-1 focus:outline-none max-h-[40vh] min-h-[24px] overflow-hidden"></textarea>
                    
                    <!-- Character Counter (plugin) -->
                    <div id="char-counter" class="hidden absolute bottom-[-18px] right-1 text-[10px] font-mono text-[var(--text-muted)] font-bold"></div>
                </div>
            </div>
        </div>
    </div>

<script>
/**
 * GLOBAL & STATE
 */
const API_BASE = 'https://discord.com/api/v10';
let WS = null;
let ACCOUNTS = JSON.parse(localStorage.getItem('discord_lite_accounts') || '[]');
let CURRENT_USER = null;
let CURRENT_CHANNEL = null;
let GUILDS = new Map();
let GUILD_FOLDERS = [];
let PENDING_FILES = [];
let MESSAGE_CACHE = new Map(); // id -> msg object
let IS_SENDING = false;

// Plugins
let PLUGINS = JSON.parse(localStorage.getItem('discord_lite_plugins') || JSON.stringify({
    clickReply: true,
    msgLogger: true,
    showCharCount: true
}));

const PLUGIN_DEFS = [
    {key: 'clickReply', name:'„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßËøî‰ø°', desc: '„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ëøî‰ø°„É¢„Éº„Éâ„Å´„Åó„Åæ„Åô'},
    {key: 'msgLogger', name:'„É°„ÉÉ„Çª„Éº„Ç∏„É≠„Ç∞', desc: 'Á∑®ÈõÜ„ÉªÂâäÈô§„Åï„Çå„Åü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Åæ„Åô'},
    {key: 'showCharCount', name:'ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Éà', desc: 'ÂÖ•Âäõ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂè≥‰∏ã„Å´ÊñáÂ≠óÊï∞„ÇíË°®Á§∫„Åó„Åæ„Åô'},
];

/**
 * INITIALIZATION
 */
document.addEventListener('DOMContentLoaded', () => {
    // Theme
    setTheme(localStorage.getItem('discord_lite_theme') || 'dark');
    
    // Auth Check
    const lastId = localStorage.getItem('discord_lite_last_uid');
    if(ACCOUNTS.length > 0 && lastId) {
        loginUser(lastId);
    } else if (ACCOUNTS.length > 0) {
        showSavedAccounts();
    } else {
        showTokenForm();
    }

    // Input handlers
    const area = document.getElementById('message-input');
    area.addEventListener('input', handleInputResize);
    area.addEventListener('keydown', handleEnterKey);

    // D&D
    setupDragDrop();
});

/* THEME SYSTEM */
function setTheme(t) {
    document.documentElement.className = t;
    localStorage.setItem('discord_lite_theme', t);
    // update modal UI
    document.getElementById('theme-card-dark').querySelector('.checked-mark').classList.toggle('hidden', t!=='dark');
    document.getElementById('theme-card-light').querySelector('.checked-mark').classList.toggle('hidden', t!=='light');
    document.getElementById('theme-card-dark').classList.toggle('ring-2', t==='dark');
    document.getElementById('theme-card-light').classList.toggle('ring-2', t==='light');
}

/* API WRAPPER */
async function req(endpoint, method='GET', body=null, isForm=false) {
    if(!CURRENT_USER) return {error:true};
    const headers = {
        'Authorization': CURRENT_USER.token,
        'X-Super-Properties': btoa(JSON.stringify({os:"Windows",browser:"Chrome",device:"",system_locale:"ja",client_build_number:262355}))
    };
    if(body && !isForm) {
        headers['Content-Type'] = 'application/json';
        body = JSON.stringify(body);
    }
    try {
        const res = await fetch(API_BASE + endpoint, { method, headers, body });
        if(res.status === 204) return {ok:true};
        if(!res.ok) throw await res.json();
        return await res.json();
    } catch(e) {
        console.error(e);
        return {error: e};
    }
}

/* WEBSOCKET */
function connectGateway() {
    if(WS) WS.close();
    WS = new WebSocket('wss://gateway.discord.gg/?v=10&encoding=json');
    let sequence = null;
    let hbInterval = null;

    WS.onmessage = (event) => {
        const p = JSON.parse(event.data);
        if(p.s) sequence = p.s;

        if(p.op === 10) { // Hello
            hbInterval = setInterval(() => {
                WS.send(JSON.stringify({op:1, d: sequence}));
            }, p.d.heartbeat_interval);
            // Identify
            WS.send(JSON.stringify({
                op: 2,
                d: {
                    token: CURRENT_USER.token,
                    properties: {$os:"linux", $browser:"disco_lite", $device:"disco_lite"},
                }
            }));
        }
        else if(p.t === 'READY') {
            if(p.d.user_settings && p.d.user_settings.guild_folders) {
                GUILD_FOLDERS = p.d.user_settings.guild_folders;
            }
            renderGuilds();
        }
        else if(p.t === 'MESSAGE_CREATE') {
            if(CURRENT_CHANNEL && p.d.channel_id === CURRENT_CHANNEL.id) {
                // If the message is from me, replace my temp "sending" message logic
                // For simplicity, we just append newly. The local "fake" one will be replaced/removed if mapped by nonce
                appendMessage(p.d, false, true); 
            }
        }
        else if(p.t === 'MESSAGE_UPDATE') {
            const m = MESSAGE_CACHE.get(p.d.id);
            if(m) {
                if(PLUGINS.msgLogger) {
                    // Update cache but keep old history if content changed
                    // Simplified implementation: rerender
                }
                // Naive implementation: merge and replace
                const newM = {...m, ...p.d};
                MESSAGE_CACHE.set(p.d.id, newM);
                const oldEl = document.getElementById('msg-'+p.d.id);
                if(oldEl) {
                    const groupMode = oldEl.querySelector('.avatar-container') === null; // kinda hacky detection
                    const newEl = createMessageElement(newM, groupMode);
                    oldEl.replaceWith(newEl);
                }
            }
        }
        else if(p.t === 'MESSAGE_DELETE') {
            const el = document.getElementById('msg-'+p.d.id);
            if(el) {
                if(PLUGINS.msgLogger) {
                    el.classList.add('message-deleted');
                    // Ensure the content turns red via class
                } else {
                    el.remove();
                }
            }
        }
    };
    WS.onclose = () => { if(hbInterval) clearInterval(hbInterval); setTimeout(connectGateway, 3000); }
}

/* LOGIN UI FLOW */
function showTokenForm() {
    document.getElementById('auth-overlay').classList.remove('hidden');
    document.getElementById('auth-account-list').classList.add('hidden');
    document.getElementById('auth-token-form').classList.remove('hidden');
    document.getElementById('auth-account-list').innerHTML = '';
}

function showSavedAccounts() {
    document.getElementById('auth-overlay').classList.remove('hidden');
    document.getElementById('auth-account-list').classList.remove('hidden');
    document.getElementById('auth-token-form').classList.add('hidden');
    const list = document.getElementById('auth-account-list');
    list.innerHTML = '';
    ACCOUNTS.forEach(acc => {
        const div = document.createElement('div');
        div.className = "flex items-center gap-3 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded border border-gray-200 dark:border-gray-600";
        div.innerHTML = `<img src="https://cdn.discordapp.com/avatars/${acc.id}/${acc.avatar}.png?size=32" class="w-8 h-8 rounded-full"><span class="font-bold text-[var(--text-normal)]">${acc.username}</span>`;
        div.onclick = () => loginUser(acc.id);
        list.appendChild(div);
    });
    
    // Login btn
    const btn = document.getElementById('btn-show-add');
    btn.onclick = showTokenForm;
}

document.getElementById('btn-login').onclick = async () => {
    const t = document.getElementById('input-token').value.trim();
    if(!t) return;
    const res = await fetch('https://discord.com/api/v10/users/@me', {headers:{Authorization:t}});
    if(res.ok) {
        const u = await res.json();
        const existing = ACCOUNTS.findIndex(a => a.id === u.id);
        u.token = t;
        if(existing !== -1) ACCOUNTS[existing] = u;
        else ACCOUNTS.push(u);
        localStorage.setItem('discord_lite_accounts', JSON.stringify(ACCOUNTS));
        loginUser(u.id);
    } else {
        document.getElementById('auth-error').innerText = "„Éà„Éº„ÇØ„É≥„ÅåÁÑ°Âäπ„Åß„Åô";
    }
};

function loginUser(uid) {
    const u = ACCOUNTS.find(a => a.id === uid);
    if(!u) return showTokenForm();
    
    CURRENT_USER = u;
    localStorage.setItem('discord_lite_last_uid', uid);
    
    // UI Update
    document.getElementById('auth-overlay').classList.add('hidden');
    const ava = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${u.discriminator%5}.png`;
    document.getElementById('current-user-avatar').src = ava;
    document.getElementById('current-user-name').innerText = u.global_name || u.username;
    document.getElementById('current-user-discriminator').innerText = '@'+u.username;

    // Load Data
    loadGuilds();
    connectGateway();
}

/* DATA LOADING */
async function loadGuilds() {
    const list = document.getElementById('guild-list');
    list.innerHTML = ''; // Reset
    
    // Cache guilds map
    const res = await req('/users/@me/guilds');
    if(!Array.isArray(res)) return; // Error handle

    res.forEach(g => GUILDS.set(g.id, g));

    // Simple Render logic: iterate guilds, check if in folder
    // For Discord Lite simplicity, skipping complex folder rendering for now, just flat list unless structure is critical
    // Let's implement flat list + folder grouping basic logic if array is populated
    
    res.forEach(g => {
        const div = document.createElement('div');
        div.className = "server-icon";
        div.innerHTML = g.icon ? 
            `<img src="https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png?size=64">` : 
            `<div class="text-sm font-bold">${g.name.substring(0,2)}</div>`;
        div.dataset.id = g.id;
        div.onclick = () => selectGuild(g.id, div);
        div.oncontextmenu = (e) => showCtx(e, [
            {label: '„Çµ„Éº„Éê„ÉºID„Çí„Ç≥„Éî„Éº', action: ()=>copyTxt(g.id)}
        ]);
        list.appendChild(div);
    });
}

async function selectGuild(gid, el) {
    document.querySelectorAll('.server-icon').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
    
    document.getElementById('guild-header').innerText = GUILDS.get(gid).name;
    document.getElementById('header-hash').classList.add('hidden');
    document.getElementById('header-channel-name').innerText = '...';
    
    // Load Channels
    const cList = document.getElementById('channel-list');
    cList.innerHTML = '<div class="loader m-4"></div>';
    
    const chans = await req(`/guilds/${gid}/channels`);
    cList.innerHTML = '';
    
    if(Array.isArray(chans)) {
        renderChannelList(chans, cList);
    }
}

async function loadDMs() {
    document.querySelectorAll('.server-icon').forEach(e => e.classList.remove('active'));
    document.getElementById('btn-dm').classList.add('active');
    document.getElementById('guild-header').innerText = "„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏";
    const cList = document.getElementById('channel-list');
    cList.innerHTML = '<div class="loader m-4"></div>';
    
    const dms = await req('/users/@me/channels');
    cList.innerHTML = '';
    
    dms.sort((a,b) => (b.last_message_id||0) - (a.last_message_id||0));
    dms.forEach(c => {
        const row = document.createElement('div');
        row.className = "channel-item px-2 py-1.5 rounded flex items-center cursor-pointer mb-[1px]";
        
        let name = "DM";
        let icon = `<div class="w-8 h-8 rounded-full bg-[var(--discord-blurple)] mr-2 flex items-center justify-center text-white text-xs">@</div>`;
        if(c.recipients && c.recipients[0]) {
            const u = c.recipients[0];
            name = u.global_name || u.username;
            icon = `<img src="https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=32" class="w-8 h-8 rounded-full mr-2">`;
        }
        row.innerHTML = `${icon}<div class="truncate font-medium">${name}</div>`;
        row.onclick = () => selectChannel(c);
        cList.appendChild(row);
    });
}

/* CHANNEL RENDERING (NESTED) */
function renderChannelList(channels, container) {
    // 0=Text, 2=Voice, 4=Category, 5=Announcement
    const categories = channels.filter(c => c.type === 4).sort((a,b) => a.position - b.position);
    const noCat = channels.filter(c => c.type !== 4 && !c.parent_id).sort((a,b) => a.position - b.position);
    const grouped = new Map(); // parent_id -> array

    channels.forEach(c => {
        if(c.parent_id) {
            if(!grouped.has(c.parent_id)) grouped.set(c.parent_id, []);
            grouped.get(c.parent_id).push(c);
        }
    });

    const createChEl = (c) => {
        const el = document.createElement('div');
        el.className = `channel-item px-2 py-1.5 rounded mb-[1px] cursor-pointer flex items-center text-[var(--text-muted)] hover:bg-[var(--channel-hover)] ${c.type===2 ? 'opacity-70':''}`;
        let icon = '#';
        if(c.type===5) icon = 'üì¢'; 
        if(c.type===2) icon = 'üîä';

        el.innerHTML = `<span class="mr-1.5 text-lg font-thin leading-none opacity-60">${icon}</span><span class="truncate font-medium">${c.name}</span>`;
        if(c.type !== 2) {
            el.onclick = () => selectChannel(c);
            el.dataset.id = c.id;
            el.oncontextmenu = (e) => showCtx(e, [{label: 'ID„Çí„Ç≥„Éî„Éº', action: ()=>copyTxt(c.id)}]);
        }
        return el;
    };

    // Render No Category first
    noCat.forEach(c => container.appendChild(createChEl(c)));

    // Render Categories
    categories.forEach(cat => {
        const wrapper = document.createElement('div');
        wrapper.className = "mt-4";
        const header = document.createElement('div');
        header.className = "flex items-center text-xs font-bold text-[var(--text-muted)] uppercase hover:text-[var(--text-normal)] cursor-pointer mb-1 px-1";
        header.innerHTML = `<svg class="cat-arrow w-3 h-3 mr-0.5 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg> ${cat.name}`;
        header.onclick = () => {
            wrapper.classList.toggle('category-collapsed');
            const kidContainer = wrapper.querySelector('.cat-children');
            kidContainer.classList.toggle('hidden');
        };

        const children = document.createElement('div');
        children.className = "cat-children";
        const kids = grouped.get(cat.id) || [];
        kids.sort((a,b) => a.position - b.position);
        
        kids.forEach(k => children.appendChild(createChEl(k)));
        
        wrapper.appendChild(header);
        wrapper.appendChild(children);
        container.appendChild(wrapper);
    });
}

/* CHAT LOGIC */
async function selectChannel(c) {
    if(c.id === CURRENT_CHANNEL?.id) return;
    CURRENT_CHANNEL = c;
    MESSAGE_CACHE.clear();
    
    document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
    const el = document.querySelector(`.channel-item[data-id="${c.id}"]`);
    if(el) el.classList.add('active');

    const titleName = c.name || (c.recipients ? c.recipients[0].username : "Chat");
    document.getElementById('header-hash').innerText = (c.type===0||c.type===5) ? '#' : '@';
    document.getElementById('header-hash').classList.remove('hidden');
    document.getElementById('header-channel-name').innerText = titleName;

    const container = document.getElementById('message-container');
    container.innerHTML = `<div class="w-full h-full flex items-center justify-center"><div class="animate-spin h-8 w-8 border-4 border-[var(--discord-blurple)] rounded-full border-t-transparent"></div></div>`;

    const msgs = await req(`/channels/${c.id}/messages?limit=50`);
    container.innerHTML = '';
    
    // Wrapper for comfortable spacing
    const padDiv = document.createElement('div');
    padDiv.className = "flex flex-col-reverse justify-end min-h-full pb-4";
    container.appendChild(padDiv);
    
    if(Array.isArray(msgs)) {
        msgs.forEach(m => MESSAGE_CACHE.set(m.id, m));
        // Reverse needed for append flow
        for (const msg of msgs) {
            // Process backwards is tricky with "Grouping" if logic relies on "Previous".
            // Since `msgs` is newest first (Discord API default), `msgs[0]` is latest.
            // UI needs oldest on top. So `msgs` reverse is correct.
        }
        
        const sorted = msgs.reverse();
        sorted.forEach((m, idx) => {
            // Grouping logic: Check if PREVIOUS message (idx-1) is same author
            const prev = idx > 0 ? sorted[idx-1] : null;
            let isGrouped = false;
            if(prev && prev.author.id === m.author.id && !m.referenced_message && !prev.webhook_id && (new Date(m.timestamp)-new Date(prev.timestamp) < 300000)) {
                // Also check if type isn't system (Join etc)
                if(m.type === 0 || m.type === 19) isGrouped = true;
            }
            appendMessage(m, isGrouped, false); 
        });
        
        container.scrollTop = container.scrollHeight;
    }
}

// Convert Discord Markdown -> HTML (Simple subset)
function parseContent(txt) {
    if(!txt) return '';
    let t = txt
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-[var(--text-link)] hover:underline">$1</a>')
        // Mentions <@ID>
        .replace(/&lt;@!?(\d+)&gt;/g, '<span class="mention">@User</span>') 
        // Emoji <a:name:id> or <:name:id> -> img
        .replace(/&lt;(a?):(\w+):(\d+)&gt;/g, (match, a, name, id) => {
            const ext = a ? 'gif' : 'png';
            return `<img src="https://cdn.discordapp.com/emojis/${id}.${ext}" class="w-6 h-6 inline-block align-bottom" title=":${name}:" alt=":${name}:">`;
        });
    return t;
}

function createMessageElement(m, grouped) {
    const wrapper = document.createElement('div');
    wrapper.id = 'msg-'+m.id;
    wrapper.className = `message-wrapper ${grouped ? 'mt-[2px] grouped' : 'mt-cozy'}`; // Add cozy margin
    wrapper.dataset.authorId = m.author.id;
    
    // Check Plugins
    if(PLUGINS.clickReply && !m.type_ephemeral) {
        wrapper.addEventListener('dblclick', () => startReply(m));
    }
    // Mention Check
    const mentionIds = m.mentions?.map(u=>u.id) || [];
    if(m.content && m.content.includes(`<@${CURRENT_USER.id}>`) || mentionIds.includes(CURRENT_USER.id)) {
        wrapper.style.backgroundColor = 'var(--mention-bg)';
        const border = document.createElement('div');
        border.style = "position:absolute;left:0;top:0;bottom:0;width:2px;background:#faa61a;";
        wrapper.appendChild(border);
    }
    
    // --- Context Menu Hook ---
    wrapper.oncontextmenu = (e) => {
        const opts = [
            {label:'„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº', action:()=>copyTxt(m.content)},
            {label:'ID„Çí„Ç≥„Éî„Éº', action:()=>copyTxt(m.id)},
            {label:'Ëøî‰ø°', action:()=>startReply(m)},
        ];
        if(m.author.id === CURRENT_USER.id && !m.type_ephemeral) {
            opts.push({label:'Á∑®ÈõÜ', action:()=>startEdit(m)});
            opts.push({label:'ÂâäÈô§', action:()=>deleteMsg(m.id)});
        }
        showCtx(e, opts);
    };

    // SYSTEM MESSAGES (Join, etc)
    if(m.type === 7) {
        wrapper.className = "px-4 py-1 text-[var(--text-muted)] flex items-center gap-2 text-sm mt-2 mb-1";
        wrapper.innerHTML = `<svg class="w-5 h-5 text-green-500 shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg> <span><b>${m.author.global_name||m.author.username}</b> „Åå„Çµ„Éº„Éê„Éº„Å´ÂèÇÂä†„Åó„Åæ„Åó„Åü„ÄÇ</span>`;
        return wrapper;
    }

    // NORMAL MESSAGE BUILD
    
    // Reference Line (Only if not grouped and has reference)
    // Structure: Flex col inside wrapper. Reference first.
    let refHTML = '';
    if(m.referenced_message && !grouped) {
        const rm = m.referenced_message;
        const authName = rm.author ? (rm.author.global_name||rm.author.username) : "Unknown";
        refHTML = `
            <div class="reference-line" onclick="scrollToMsg('${rm.id}')">
                <div class="reference-spine"></div>
                <img src="${rm.author ? `https://cdn.discordapp.com/avatars/${rm.author.id}/${rm.author.avatar}.png?size=16` : ''}" class="w-4 h-4 rounded-full bg-gray-500">
                <span class="font-bold hover:underline cursor-pointer">@${authName}</span>
                <span class="truncate max-w-xs cursor-pointer hover:text-[var(--text-normal)]">${rm.content}</span>
            </div>
        `;
    }

    const row = document.createElement('div');
    row.className = "msg-row";

    // --- Left Col ---
    const leftCol = document.createElement('div');
    leftCol.className = "msg-left-col";

    if(!grouped) {
        const ava = m.author.avatar ? `https://cdn.discordapp.com/avatars/${m.author.id}/${m.author.avatar}.png?size=64` : `https://cdn.discordapp.com/embed/avatars/${m.author.discriminator%5}.png`;
        let decoHTML = '';
        if(m.author.avatar_decoration_data) {
             const decURL = `https://cdn.discordapp.com/avatar-decoration-presets/${m.author.avatar_decoration_data.asset}.png?size=96`;
             decoHTML = `<img src="${decURL}" class="avatar-decoration">`;
        }
        
        leftCol.innerHTML = `
            <div class="avatar-container">
                <img src="${ava}" class="avatar-img shadow-sm group-hover:shadow-md transition">
                ${decoHTML}
            </div>
        `;
    } else {
        // Empty gutter, timestamp on hover (omitted for brevity)
        // Only show timestamp if desired
        // leftCol.innerHTML = `<span class="text-[10px] hidden group-hover:block w-full text-right mt-1 opacity-50">${shortTime(m.timestamp)}</span>`;
    }

    // --- Right Col ---
    const rightCol = document.createElement('div');
    rightCol.className = "msg-right-col";

    // Header (Name + Date) - Only if not grouped
    if(!grouped) {
        const u = m.author;
        const colorStyle = m.member?.color ? `color: #${m.member.color.toString(16).padStart(6,'0')}` : '';
        const botTag = u.bot ? `
            <span class="bot-badge">
                <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24"><path d="M5.5 12h2a.5.5 0 00.5-.5V8a2 2 0 012-2h4a2 2 0 012 2v3.5a.5.5 0 00.5.5h2a.5.5 0 00.5-.5V10a6 6 0 00-6-6h-2a6 6 0 00-6 6v1.5a.5.5 0 00.5.5z" fill="currentColor"/><path d="M7 16a2 2 0 114 0 2 2 0 01-4 0zM17 16a2 2 0 11-4 0 2 2 0 014 0z" fill="currentColor"/></svg>
                APP
            </span>` : '';

        rightCol.innerHTML = `
            <div class="msg-header">
                <span class="msg-username" style="${colorStyle}">${m.member?.nick || u.global_name || u.username}</span>
                ${botTag}
                <span class="msg-timestamp">${longTime(m.timestamp)}</span>
            </div>
        `;
    }

    // Content Body
    let contentBody = parseContent(m.content);
    if(m.edited_timestamp) contentBody += ' <span class="text-[0.625rem] text-[var(--text-muted)] cursor-help select-none" title="Edited">(Á∑®ÈõÜÊ∏à)</span>';
    
    // Attachments
    let attHTML = '';
    if(m.attachments && m.attachments.length > 0) {
        attHTML += '<div class="flex flex-col gap-2 mt-2">';
        m.attachments.forEach(a => {
            if(a.content_type?.startsWith('image/')) {
                attHTML += `<a href="${a.url}" target="_blank"><img src="${a.url}" class="max-w-[320px] max-h-[320px] rounded-lg border border-[var(--divider)]"></a>`;
            } else {
                attHTML += `<div class="p-3 rounded bg-[var(--bg-tertiary)] border border-[var(--divider)] w-fit flex items-center gap-2"><div class="text-2xl">üìÑ</div><div><a href="${a.url}" target="_blank" class="text-[var(--text-link)] hover:underline text-sm font-bold block">${a.filename}</a><span class="text-xs text-[var(--text-muted)]">${(a.size/1024).toFixed(1)} KB</span></div></div>`;
            }
        });
        attHTML += '</div>';
    }

    // Embeds? (omitted basic impl)

    // Append Content to Right Col
    const bodyEl = document.createElement('div');
    bodyEl.className = "msg-content";
    if(m.type_ephemeral) bodyEl.classList.add('ephemeral-message');

    bodyEl.innerHTML = contentBody + attHTML;

    // Ephemeral Clyde Footer
    if(m.type_ephemeral) {
        bodyEl.innerHTML += `<div class="ephemeral-text">„Åì„Çå„Çâ„ÅØ„ÅÇ„Å™„Åü„Å´„Å†„ÅëË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô ‚Ä¢ <span class="text-[var(--text-link)] cursor-pointer hover:underline" onclick="this.closest('.message-wrapper').remove()">„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§</span></div>`;
    }

    rightCol.appendChild(bodyEl);
    
    // Assemble
    row.appendChild(leftCol);
    row.appendChild(rightCol);

    wrapper.innerHTML = refHTML; // Ref on top
    wrapper.appendChild(row); // Body

    // TOOLBAR SVG
    if(!m.type_ephemeral) {
        const tb = document.createElement('div');
        tb.className = 'msg-toolbar';
        
        // Add Reaction (Smiley)
        const btnReact = `
            <div class="toolbar-btn" title="„É™„Ç¢„ÇØ„Ç∑„Éß„É≥">
            <svg class="icon-svg" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.251 2.003A10.003 10.003 0 0 0 12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10c0-2.02-.63-3.9-1.71-5.47a.99.99 0 0 0-1.72.84 8.01 8.01 0 1 1 5.92-3.11.99.99 0 0 0 1.25-1.56 10.15 10.15 0 0 0-3.489-1.697ZM9 12a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm3 3.5a3.5 3.5 0 0 0 3.46-3 .99.99 0 0 0-1.9-.38A1.51 1.51 0 0 1 12 13.5a1.51 1.51 0 0 1-1.56-1.38.99.99 0 0 0-1.9.38A3.5 3.5 0 0 0 12 15.5Zm3.5-2.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>
            </div>`;
            
        // Reply
        const btnReply = `
            <div class="toolbar-btn" title="Ëøî‰ø°" onclick='startReply(${JSON.stringify({id:m.id, author:m.author})})'>
            <svg class="icon-svg" fill="currentColor" viewBox="0 0 24 24"><path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/></svg>
            </div>`;
            
        // Edit (Owner only)
        const btnEdit = (m.author.id === CURRENT_USER.id) ? `
            <div class="toolbar-btn" title="Á∑®ÈõÜ" onclick="startEdit({id:'${m.id}'})">
            <svg class="icon-svg" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </div>` : '';

        // Delete (Owner only)
        const btnDel = (m.author.id === CURRENT_USER.id) ? `
            <div class="toolbar-btn hover:text-red-500" title="ÂâäÈô§" onclick="deleteMsg('${m.id}')">
            <svg class="icon-svg" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </div>` : '';

        tb.innerHTML = btnReact + btnReply + btnEdit + btnDel;
        wrapper.appendChild(tb);
    }
    
    return wrapper;
}

function appendMessage(m, grouped, autoScroll) {
    const c = document.getElementById('message-container');
    const bottomDiv = c.lastElementChild; // Usually padding div
    // Determine strict position
    // If autoScroll is TRUE (usually for new socket msgs), append before bottom spacer
    const el = createMessageElement(m, grouped);
    c.insertBefore(el, bottomDiv); // Insert before padding

    if(autoScroll) {
        c.scrollTop = c.scrollHeight;
    }
}

// "I AM SPEAKING" Fix (prev user merge issue)
function handleSendMessage() {
    const txt = document.getElementById('message-input').value.trim();
    if(!txt && PENDING_FILES.length === 0) return;
    
    IS_SENDING = true;
    
    const now = new Date();
    // Use negative ID to not conflict real API
    const tempID = 'loc-' + now.getTime();
    
    // Check previous message for grouping
    const container = document.getElementById('message-container');
    const lastMsg = container.children.length > 1 ? container.children[container.children.length - 2] : null;
    let grouped = false;
    
    // Prevent merge if last msg was from different person OR time gap too big
    if(lastMsg && lastMsg.dataset.authorId === CURRENT_USER.id) {
        grouped = true; 
    }

    const tempMsg = {
        id: tempID,
        content: txt,
        author: CURRENT_USER,
        timestamp: now.toISOString(),
        nonce: tempID,
        attachments: PENDING_FILES.map(f => ({filename: f.name, url:'#', size:f.size})),
        isSending: true
    };
    
    MESSAGE_CACHE.set(tempID, tempMsg);
    appendMessage(tempMsg, grouped, true);

    // Clean Input
    document.getElementById('message-input').value = '';
    document.getElementById('file-preview-list').innerHTML = '';
    PENDING_FILES = [];

    // Actually Send
    sendMessage(txt, tempID);
}

async function sendMessage(txt, nonce) {
    if(!CURRENT_CHANNEL) return;
    // ...Form Construction
    const fd = new FormData();
    const payload = {
        content: txt, 
        message_reference: replyTarget ? { message_id: replyTarget.messageId } : undefined
    };
    fd.append('payload_json', JSON.stringify(payload));
    
    // API logic ...
    try {
        const res = await fetch(`${API_BASE}/channels/${CURRENT_CHANNEL.id}/messages`, {
            method: 'POST',
            headers: {'Authorization': CURRENT_USER.token},
            body: fd
        });

        if(!res.ok) {
            // Error! Replace local message with Clyde Error
            const err = await res.json();
            const tempEl = document.getElementById('msg-'+nonce);
            if(tempEl) tempEl.remove();
            
            renderClydeError(`„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${err.message || 'Unknown Error'}`);
        } else {
            // Success: Wait for WS MESSAGE_CREATE to verify
            cancelReply();
        }
    } catch(e) {
        const tempEl = document.getElementById('msg-'+nonce);
        if(tempEl) tempEl.remove();
        renderClydeError("„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
    }
}

function renderClydeError(msg) {
    // FAKE BOT "Clyde"
    const clyde = {
        id: 'error-'+Date.now(),
        type_ephemeral: true,
        content: msg,
        author: {
            id: 'clyde',
            username: 'Clyde',
            global_name: 'Clyde',
            avatar: null, // use SVG locally or something
            bot: true
        },
        timestamp: new Date().toISOString()
    };
    appendMessage(clyde, false, true);
}

/** 
 * UTILS
 */
function copyTxt(t) { navigator.clipboard.writeText(t); document.getElementById('ctx-menu').classList.add('hidden'); }

let replyTarget = null;
function startReply(m) {
    replyTarget = {messageId: m.id};
    document.getElementById('reply-bar').classList.remove('hidden');
    document.getElementById('reply-bar').classList.add('flex');
    document.getElementById('reply-user').innerText = m.author.global_name||m.author.username;
    document.getElementById('message-input').focus();
    document.getElementById('ctx-menu').classList.add('hidden');
}

function cancelReply() {
    replyTarget = null;
    document.getElementById('reply-bar').classList.add('hidden');
}

// Arrow Key Edit (Last Message)
function handleEnterKey(e) {
    if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
    }
    if(e.key === 'ArrowUp' && e.target.value === '') {
        e.preventDefault();
        // find last own message
        const els = document.querySelectorAll('.message-wrapper');
        for(let i=els.length-1; i>=0; i--) {
            if(els[i].dataset.authorId === CURRENT_USER.id) {
                // Trigger edit mode (not fully implemented in snippet)
                startEdit({id: els[i].id.replace('msg-', '')});
                break;
            }
        }
    }
}

// Basic Editing Textarea Replace (Snippet)
function startEdit(mObj) {
    const el = document.getElementById('msg-'+mObj.id);
    if(!el) return;
    const body = el.querySelector('.msg-content');
    const oldHTML = body.innerHTML; // Cache html to revert
    const raw = MESSAGE_CACHE.get(mObj.id)?.content || "";
    
    body.innerHTML = `
    <div class="bg-[var(--bg-tertiary)] p-2 rounded">
        <input class="w-full bg-[var(--bg-secondary)] p-2 rounded text-[var(--text-normal)]" value="${raw.replace(/"/g, '&quot;')}">
        <div class="text-xs mt-1">
             escape „Åß„Ç≠„É£„É≥„Çª„É´ ‚Ä¢ enter „Åß <span class="text-blue-500 cursor-pointer" onclick="confirmEdit('${mObj.id}')">‰øùÂ≠ò</span>
        </div>
    </div>`;
    
    const inp = body.querySelector('input');
    inp.focus();
    inp.onkeydown = async (e) => {
        if(e.key==='Enter') {
             await req(`/channels/${CURRENT_CHANNEL.id}/messages/${mObj.id}`, 'PATCH', {content: inp.value});
        }
        if(e.key==='Escape') {
             const m = MESSAGE_CACHE.get(mObj.id);
             el.replaceWith(createMessageElement(m, el.classList.contains('grouped')));
        }
    }
}

async function deleteMsg(id) {
    await req(`/channels/${CURRENT_CHANNEL.id}/messages/${id}`, 'DELETE');
    // Visual removal handled by WS
}

// CTX MENU POS
function showCtx(e, items) {
    e.preventDefault();
    const m = document.getElementById('ctx-menu');
    m.innerHTML = '';
    items.forEach(i => {
        const d = document.createElement('div');
        d.className = 'ctx-item';
        d.innerHTML = `<span>${i.label}</span>`;
        d.onclick = i.action;
        m.appendChild(d);
    });
    
    m.classList.remove('hidden');
    let x = e.pageX, y = e.pageY;
    if(x + 180 > window.innerWidth) x -= 180;
    m.style.left = x+'px';
    m.style.top = y+'px';
}
document.addEventListener('click', () => document.getElementById('ctx-menu').classList.add('hidden'));

// Time Formats
function longTime(iso) { return new Date(iso).toLocaleString('ja-JP'); }

function openSettings() {
    document.getElementById('settings-modal').classList.remove('hidden');
    // Render Plugins
    const list = document.getElementById('plugin-list');
    list.innerHTML = '';
    PLUGIN_DEFS.forEach(p => {
        list.innerHTML += `
        <div class="flex items-center justify-between border-b border-[var(--divider)] pb-2">
            <div>
                <div class="font-bold text-[var(--text-normal)]">${p.name}</div>
                <div class="text-xs text-[var(--text-muted)]">${p.desc}</div>
            </div>
            <div class="cursor-pointer text-2xl ${PLUGINS[p.key]?'text-green-500':'text-gray-500'}" onclick="togglePlugin('${p.key}', this)">
                ${PLUGINS[p.key] ? '‚ñ†' : '‚ñ°'}
            </div>
        </div>`;
    });
    
    setTimeout(()=>document.getElementById('settings-modal').classList.remove('opacity-0'), 10);
    setTimeout(()=>document.getElementById('settings-inner').classList.remove('scale-95'), 10);
}

function closeSettings() {
    document.getElementById('settings-inner').classList.add('scale-95');
    document.getElementById('settings-modal').classList.add('opacity-0');
    setTimeout(()=>document.getElementById('settings-modal').classList.add('hidden'), 200);
}

function togglePlugin(k, btn) {
    PLUGINS[k] = !PLUGINS[k];
    btn.className = `cursor-pointer text-2xl ${PLUGINS[k]?'text-green-500':'text-gray-500'}`;
    btn.innerText = PLUGINS[k]?'‚ñ†':'‚ñ°';
    localStorage.setItem('discord_lite_plugins', JSON.stringify(PLUGINS));
}

// Helpers
function handleInputResize(e) { e.target.style.height='auto'; e.target.style.height=e.target.scrollHeight+'px'; }
function setupDragDrop() {
    document.addEventListener('dragenter', e=>{e.preventDefault();document.body.classList.add('dragging')});
    document.getElementById('drag-overlay').addEventListener('dragleave', e=>{e.preventDefault();document.body.classList.remove('dragging')});
    document.addEventListener('dragover', e=>e.preventDefault());
    document.addEventListener('drop', e=>{
        e.preventDefault();
        document.body.classList.remove('dragging');
        if(e.dataTransfer.files.length>0) alert('„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ(Êú™ÂÆüË£Ö)');
    });
}
function switchSettingsTab(t){
    document.getElementById('tab-content-plugins').className = t==='plugins'?'block':'hidden';
    document.getElementById('tab-content-general').className = t==='general'?'block':'hidden';
    document.getElementById('tab-btn-plugins').classList.toggle('bg-[var(--bg-tertiary)]', t==='plugins');
    document.getElementById('tab-btn-general').classList.toggle('bg-[var(--bg-tertiary)]', t==='general');
}
</script>
</body>
</html>
